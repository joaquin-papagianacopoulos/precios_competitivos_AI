<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comparador de Precios - Mayoristas</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary:#007bff;--primary-dark:#0056b3;--success:#28a745;--danger:#dc3545;
      --bg-grad:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    }
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-grad);min-height:100vh;padding:16px}
    .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,.96);border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
    .header{background:linear-gradient(135deg,#2c3e50 0%,#34495e 100%);color:#fff;padding:28px 20px;text-align:center;position:relative}
    .header h1{font-size:clamp(1.6rem,3.5vw,2.5rem);font-weight:700;margin-bottom:8px}
    .header p{opacity:.9;font-size:clamp(.95rem,2.2vw,1.1rem)}
    .ai-badge{position:absolute;top:16px;right:16px;background:#28a745;color:#fff;padding:8px 14px;border-radius:20px;font-size:.8rem;font-weight:700;text-transform:uppercase}

    .main-content{display:grid;grid-template-columns:1fr 340px;min-height:70vh}
    .left-panel{padding:24px}
    .sidebar{background:#f8f9fa;border-left:1px solid #e9ecef;padding:24px}

    .section-title{font-size:1.15rem;font-weight:700;color:#2c3e50;margin-bottom:16px;display:flex;align-items:center;gap:10px}
    .upload-form{background:#fff;padding:20px;border-radius:15px;border:3px dashed var(--primary);transition:.25s}
    .upload-form:hover{border-color:var(--success);background:#f4fff6;transform:translateY(-1px)}
    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:6px;font-weight:600;color:#495057}
    .form-input{width:100%;padding:14px 16px;font-size:1rem;border:2px solid #e9ecef;border-radius:10px;outline:0;transition:.2s;background:#fff}
    .form-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,123,255,.12)}

    .file-input{position:absolute;left:-9999px}
    .file-input-button,.submit-btn{
      width:100%;min-height:44px;padding:14px 16px;border:none;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:.2s
    }
    .file-input-button{background:linear-gradient(135deg,#28a745 0%,#20c997 100%)}
    .file-input-button:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(40,167,69,.28)}
    .submit-btn{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%)}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(0,123,255,.28)}

    .search-container{position:relative;margin-bottom:16px}
    .search-input{width:100%;padding:14px 18px;font-size:1.05rem;border:2px solid #e9ecef;border-radius:999px;background:#fff;outline:0;transition:.2s}
    .search-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,123,255,.12)}
    .search-controls{display:flex;gap:10px;margin-top:12px}
    .search-btn,.clear-btn{
      flex:1;min-height:44px;border:none;border-radius:999px;color:#fff;font-weight:700;cursor:pointer;transition:.2s
    }
    .search-btn{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%)}
    .clear-btn{background:linear-gradient(135deg,#dc3545 0%,#c82333 100%)}
    
    /* === RESULTADOS CON SCROLL HORIZONTAL === */
    .results-section{
      min-height:360px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      scrollbar-gutter:stable;
    }
    
    .results-info{margin:16px 0;padding:12px;border-radius:10px;background:#e3f2fd;color:#1565c0;font-weight:600;display:flex;justify-content:space-between;align-items:center}

    .results-table{
      width:100%;
      min-width:780px;
      border-collapse:collapse;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 5px 15px rgba(0,0,0,.08);
    }
    .results-table th{background:linear-gradient(135deg,#495057 0%,#6c757d 100%);color:#fff;padding:14px 10px;text-align:left;font-size:.85rem;letter-spacing:.5px;text-transform:uppercase}
    .results-table td{padding:12px;border-bottom:1px solid #f0f0f0;vertical-align:middle}
    .results-table tr:last-child td{border-bottom:none}
    .results-table tr:hover{background:#f8f9fa;transition:.15s}

    .product-name-cell{font-weight:700;color:#2c3e50}
    .price-cell{font-weight:800;font-size:1.05rem;color:#28a745;white-space:nowrap}
    .supplier-cell{font-weight:700;color:#007bff;font-size:.85rem;letter-spacing:.3px;text-transform:uppercase}

    .list-item{background:#fff;padding:14px;border-radius:10px;border:1px solid #e9ecef;position:relative;margin-bottom:10px;transition:.2s}
    .list-item:hover{transform:translateX(4px);box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .remove-btn{position:absolute;top:10px;right:10px;background:#dc3545;color:#fff;border:none;border-radius:50%;width:26px;height:26px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}

    .stats-section{background:#fff;padding:18px;border-radius:10px;border:1px solid #e9ecef}
    .stat-item{display:flex;justify-content:space-between;padding:6px 0}
    .stat-label{color:#6c757d}
    .stat-value{font-weight:700;color:#2c3e50}

    .status-message{padding:14px;border-radius:10px;margin:12px 0;font-weight:600}
    .status-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .status-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .status-info{background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb}
    .debug-info{background:#f8f9fa;border:1px solid #e9ecef;border-radius:10px;padding:12px;margin:10px 0;font-family:'Courier New',monospace;font-size:.85rem;color:#495057}

    /* Logout fijo */
    .logout-wrap{position:fixed;top:16px;left:16px;z-index:1000}
    .logout-btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem .9rem;border-radius:9999px;border:1px solid #1c2947;background:#0f172a;color:#e8edf7;cursor:pointer;min-height:40px;text-decoration:none;font-size:.9rem}

    /* === RESPONSIVE DESIGN === */
    @media (max-width: 768px) {
      body{padding:8px}
      
      .container{border-radius:10px}
      
      .header{padding:20px 16px}
      .header h1{font-size:1.5rem}
      
      .ai-badge{position:static;display:inline-block;margin-bottom:10px;font-size:.7rem;padding:6px 10px}
      
      .main-content{
        grid-template-columns:1fr;
        min-height:auto;
      }
      
      .left-panel{padding:16px}
      .sidebar{
        border-left:none;
        border-top:1px solid #e9ecef;
        padding:16px;
      }
      
      .upload-form{padding:16px}
      .form-input{padding:12px 14px;font-size:.95rem}
      
      .search-controls{flex-direction:column}
      .search-btn,.clear-btn{flex:none;margin-bottom:8px}
      
      .results-section{
        margin-top:16px;
        padding-bottom:10px;
      }
      
      .results-table{
        min-width:600px;
        font-size:.9rem;
      }
      .results-table th{padding:10px 8px;font-size:.75rem}
      .results-table td{padding:10px 8px}
      
      .logout-wrap{position:fixed;top:8px;left:8px}
      .logout-btn{padding:.4rem .7rem;min-height:36px;font-size:.8rem}
    }

    @media (max-width: 480px) {
      body{padding:4px}
      
      .header{padding:16px 12px}
      .header h1{font-size:1.3rem}
      .header p{font-size:.9rem}
      
      .left-panel,.sidebar{padding:12px}
      
      .upload-form{padding:12px}
      .form-input{padding:10px 12px}
      
      .results-table{
        min-width:500px;
        font-size:.85rem;
      }
      .results-table th{padding:8px 6px;font-size:.7rem}
      .results-table td{padding:8px 6px}
      
      .section-title{font-size:1rem}
      
      .logout-btn span:last-child{display:none}
    }

    /* Scroll horizontal personalizado */
    .results-section::-webkit-scrollbar{
      height:12px;
    }
    .results-section::-webkit-scrollbar-track{
      background:#f1f1f1;
      border-radius:6px;
    }
    .results-section::-webkit-scrollbar-thumb{
      background:#c1c1c1;
      border-radius:6px;
    }
    .results-section::-webkit-scrollbar-thumb:hover{
      background:#a8a8a8;
    }

    /* Animaci√≥n del spinner */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .spinner {
      animation: spin 1s linear infinite;
    }

    /* Touch improvements para m√≥viles */
    @media (hover: none) and (pointer: coarse) {
      .file-input-button:hover,
      .submit-btn:hover,
      .search-btn:hover,
      .clear-btn:hover {
        transform:none;
        box-shadow:none;
      }
      
      .upload-form:hover {
        transform:none;
      }
      
      .list-item:hover {
        transform:none;
      }
    }

    /* Barra horizontal visible (espejo) */
    .xbar{
      display:none;
      height:12px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      scrollbar-gutter:stable both-edges;
      background:#eef1f4;
      border-radius:8px;
      margin-top:6px;
    }
    .xbar::-webkit-scrollbar{ height:10px; }
    .xbar::-webkit-scrollbar-track{ background:#eef1f4; border-radius:8px; }
    .xbar::-webkit-scrollbar-thumb{ background:#c9d1d9; border-radius:8px; }
    .xbar::-webkit-scrollbar-thumb:hover{ background:#b5bec7; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="ai-badge">üöö DistriSulpi</div>
      <h1>üõçÔ∏è Comparador de Precios</h1>
      <p>Sistema inteligente para DistriSulpi</p>
    </div>

    <div class="main-content">
      <div class="left-panel">
        <!-- Upload -->
        <div class="upload-section">
          <h3 class="section-title">üìÅ Cargar Lista de Precios</h3>

          <form id="uploadForm" class="upload-form" aria-label="Subir lista de precios">
            <div class="form-group">
              <label class="form-label" for="supplierName">Nombre del Proveedor</label>
              <input type="text" id="supplierName" class="form-input" placeholder="Ej: Distribuidora ABC" required />
            </div>

            <div class="form-group">
              <label class="form-label" for="supplierAddress">Direcci√≥n del Proveedor</label>
              <input type="text" id="supplierAddress" class="form-input" placeholder="Ej: Av. Corrientes 1234, CABA" />
            </div>

            <div class="form-group">
              <label class="form-label" for="supplierPhone">Tel√©fono del Proveedor</label>
              <input type="tel" id="supplierPhone" class="form-input" placeholder="Ej: +54 11 5555-5555" />
            </div>

            <div class="form-group">
              <label class="form-label" for="supplierEmail">Email</label>
              <input type="email" id="supplierEmail" class="form-input" placeholder="Ej: ejemplo@gmail.com" />
            </div>

            <div class="form-group">
              <label class="form-label">Archivo Excel</label>
              <div class="file-input-wrapper">
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" required />
                <button type="button" class="file-input-button" onclick="document.getElementById('fileInput').click()">üìä Seleccionar Archivo</button>
              </div>
            </div>

            <button type="submit" class="submit-btn">üöÄ Cargar Lista</button>
          </form>

          <div id="uploadStatus" role="status" aria-live="polite"></div>
        </div>

        <!-- B√∫squeda -->
        <div class="search-section">
          <h3 class="section-title">üîç Buscar Productos</h3>
          <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="Buscar productos en todas las listas..." />
          </div>
          <div class="search-controls">
            <button class="search-btn" onclick="searchProducts()">üîç Buscar</button>
            <button class="clear-btn" onclick="clearLists()">üóëÔ∏è Limpiar Todo</button>
          </div>
        </div>

        <!-- Resultados -->
        <div class="results-section">
          <div id="searchResults">
          <div id="xbar" class="xbar" aria-hidden="true"><div></div></div>  
            <div class="no-results" style="text-align:center;padding:48px 16px;color:#6c757d">
              <p>üëÜ Carga tu primera lista de precios y comienza a buscar</p>
              <p style="margin-top:10px;font-size:.9rem;color:#28a745">‚ú® Sistema preparado para integraci√≥n con IA</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="loaded-lists">
          <h4 class="section-title">üìã Listas Cargadas</h4>
          <div id="loadedLists">
            <p style="color:#6c757d;text-align:center;padding:20px">No hay listas cargadas</p>
          </div>
        </div>

        <div class="stats-section" aria-label="Estad√≠sticas">
          <h4 style="margin-bottom:10px;color:#2c3e50">üìä Estad√≠sticas</h4>
          <div class="stat-item"><span class="stat-label">Total listas:</span><span class="stat-value" id="totalLists">0</span></div>
          <div class="stat-item"><span class="stat-label">Productos totales:</span><span class="stat-value" id="totalProducts">0</span></div>
          <div class="stat-item"><span class="stat-label">√öltima b√∫squeda:</span><span class="stat-value" id="lastSearch">-</span></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Logout fijo -->
  <div class="logout-wrap">
    <form action="{{ url_for('logout') }}" method="post">
      <button type="submit" class="logout-btn" title="Cerrar sesi√≥n">
        <span>‚üµ</span><span>Cerrar sesi√≥n</span>
      </button>
    </form>
  </div>

  <script>
    // Cargar info de listas al inicio
    loadListsInfo();

    // Upload handler
    document.getElementById('uploadForm').addEventListener('submit', function(e){
      e.preventDefault();
      const fileInput = document.getElementById('fileInput');
      if(!fileInput.files[0]){ showStatus('error','Por favor selecciona un archivo'); return; }

      const fd = new FormData();
      fd.append('file', fileInput.files[0]);
      fd.append('supplier_name', document.getElementById('supplierName').value);
      fd.append('supplier_address', document.getElementById('supplierAddress').value);
      fd.append('supplier_phone', document.getElementById('supplierPhone').value);
      fd.append('supplier_email', document.getElementById('supplierEmail').value);

      showStatus('info','‚è≥ Procesando archivo...');

      fetch('/upload',{method:'POST',body:fd})
        .then(r=>r.json())
        .then(data=>{
          if(data.success){
            showStatus('success','‚úÖ '+data.message);
            if(data.debug_info) showDebug(data.debug_info);
            loadListsInfo();
            document.getElementById('uploadForm').reset();
            updateFileButton();
          }else{
            showStatus('error','‚ùå '+(data.error||'Error desconocido'));
            if(data.debug_info) showDebug(data.debug_info);
          }
        })
        .catch(err=>showStatus('error','üî¥ Error de conexi√≥n: '+err.message));
    });

    // Buscar con Enter
    document.getElementById('searchInput').addEventListener('keypress', e=>{
      if(e.key==='Enter') searchProducts();
    });

    // Bot√≥n archivo
    document.getElementById('fileInput').addEventListener('change', updateFileButton);
    function updateFileButton(){
      const fi = document.getElementById('fileInput');
      const btn = document.querySelector('.file-input-button');
      btn.textContent = fi.files[0] ? 'üìä '+fi.files[0].name : 'üìä Seleccionar Archivo';
    }

    function searchProducts(){
      const q = document.getElementById('searchInput').value.trim();
      const results = document.getElementById('searchResults');
      if(!q){ showStatus('error','üîç Ingresa un t√©rmino de b√∫squeda'); return; }
      results.innerHTML = '<div class="loading" style="text-align:center;padding:32px;color:#007bff"><div class="spinner" style="border:4px solid #f3f3f3;border-top:4px solid #007bff;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 16px"></div>Buscando "'+q+'"...</div>';
      fetch('/search?q='+encodeURIComponent(q))
        .then(r=>r.json())
        .then(data=>{ displayResults(data); document.getElementById('lastSearch').textContent=q; })
        .catch(err=>{ results.innerHTML = '<div class="no-results" style="text-align:center;padding:40px;color:#6c757d">‚ùå Error: '+err.message+'</div>';});
    }

    function displayResults(data){
      const host = document.getElementById('searchResults');
      if(!data || !data.total){ host.innerHTML = '<div class="no-results" style="text-align:center;padding:40px;color:#6c757d">No se encontraron productos.</div>'; return; }
      initXbar(document.querySelector('.results-section'));

      const header = `
        <div class="results-info">
          <div>üìä ${data.total} resultado(s) para "<strong>${(data.query||'')}</strong>"</div>
        </div>
        <table class="results-table" role="table" aria-label="Resultados de b√∫squeda">
          <thead><tr>
            <th>Producto</th><th>Precio</th><th>Mayorista</th>
          </tr></thead>
          <tbody>
      `;

      const rows = data.results.map(p=>`
        <tr role="row">
          <td class="product-name-cell" data-label="Producto">${p.product}</td>
          <td class="price-cell" data-label="Precio">${p.price_formatted}</td>
          <td class="supplier-cell" data-label="Mayorista">${p.supplier}</td>
        </tr>
      `).join('');

      host.innerHTML = header + rows + '</tbody></table>';
    }

    function loadListsInfo(){
      fetch('/lists').then(r=>r.json()).then(data=>{
        const listsDiv = document.getElementById('loadedLists');
        if(!data.total){ listsDiv.innerHTML='<p style="color:#6c757d;text-align:center;padding:20px">No hay listas cargadas</p>'; updateStats(0,0); return; }
        let totalProducts = 0;
        listsDiv.innerHTML = data.lists.map(list=>{
          totalProducts += list.total_products;
          return `
            <div class="list-item">
              <button class="remove-btn" onclick="removeList('${list.supplier}')" title="Eliminar">√ó</button>
              <div class="list-name" style="font-weight:700;color:#2c3e50;margin-bottom:4px">${list.supplier}</div>
              <div class="list-info" style="font-size:.9rem;color:#6c757d">
                ${list.total_products} productos<br>
                <small>${list.direccion ? 'üìç '+list.direccion+'<br>' : ''}${list.telefono ? '‚òéÔ∏è '+list.telefono+'<br>' : ''}Archivo: ${list.filename}</small>
              </div>
            </div>
          `;
        }).join('');
        updateStats(data.total,totalProducts);
      });
    }

    function updateStats(totalLists,totalProducts){
      document.getElementById('totalLists').textContent = totalLists;
      document.getElementById('totalProducts').textContent = (totalProducts||0).toLocaleString('es-AR');
    }

    function clearLists(){
      if(!confirm('¬øEliminar TODAS las listas cargadas?')) return;
      fetch('/clear').then(r=>r.json()).then(data=>{
        showStatus('success','üóëÔ∏è '+data.message);
        loadListsInfo();
        document.getElementById('searchResults').innerHTML = '<div class="no-results" style="text-align:center;padding:40px;color:#6c757d">üóëÔ∏è Todas las listas fueron eliminadas</div>';
        document.getElementById('searchInput').value='';
        document.getElementById('lastSearch').textContent='-';
      });
    }

    function removeList(supplier){
      if(!confirm(`¬øEliminar lista de ${supplier}?`)) return;
      fetch('/remove_list/'+encodeURIComponent(supplier))
        .then(r=>r.json())
        .then(data=>{
          showStatus(data.success?'success':'error', (data.success?'‚úÖ ':'‚ùå ')+(data.message||''));
          loadListsInfo();
          const q = document.getElementById('searchInput').value.trim();
          if(q){ setTimeout(()=>searchProducts(),500); }
        });
    }

    function showStatus(type,msg){
      const div = document.getElementById('uploadStatus');
      div.innerHTML = `<div class="status-message status-${type}">${msg}</div>`;
      setTimeout(()=>{div.innerHTML='';},5000);
    }
    function showDebug(data) {
        const div = document.getElementById('uploadStatus');
        
        // Convertir diferentes tipos de datos a array de strings para mostrar
        let debugLines = [];
        
        if (Array.isArray(data)) {
            // Si es un array, convertir cada elemento a string
            debugLines = data.map(item => String(item));
        } else if (data && typeof data === 'object') {
            // Si es un objeto, mostrar sus propiedades
            debugLines = Object.entries(data).map(([key, value]) => `${key}: ${value}`);
        } else if (data !== null && data !== undefined) {
            // Si es un valor primitivo, convertir a string y poner en array
            debugLines = [String(data)];
        } else {
            // Si es null o undefined
            debugLines = ['No data provided'];
        }
        
        div.innerHTML += `<div class="debug-info"><strong>üîß Debug:</strong><br>${debugLines.join('<br>')}</div>`;
    }

  function initXbar(scroller){
    const xbar = document.getElementById('xbar');
    if(!xbar || !scroller) return;
    const inner = xbar.firstElementChild;

    function refresh(){
      // iguala el ancho del "espejo" al scrollWidth real
      inner.style.width = scroller.scrollWidth + 'px';
      // mostrar solo si es m√°s ancho que el viewport
      xbar.style.display = (scroller.scrollWidth > scroller.clientWidth) ? 'block' : 'none';
      xbar.scrollLeft = scroller.scrollLeft;
    }

    // sincronizaci√≥n en ambos sentidos
    xbar.onscroll = () => { scroller.scrollLeft = xbar.scrollLeft; };
    scroller.onscroll = () => { xbar.scrollLeft = scroller.scrollLeft; };

    // refrescar en resize y cuando cambian los resultados
    window.addEventListener('resize', refresh);
    // un peque√±o defer para esperar al layout
    setTimeout(refresh, 0);
  }
  // Agregar esto a tu index.html en el panel de admin

  // Funci√≥n mejorada para manejar la respuesta del upload con debugging
  function handleUploadResponse(response) {
      const messageDiv = document.getElementById('uploadMessage');
      
      if (response.success) {
          // Upload exitoso
          messageDiv.className = 'alert alert-success';
          messageDiv.innerHTML = `
              <h4>‚úÖ ${response.message}</h4>
              <div class="mt-3">
                  <strong>Detalles:</strong>
                  <ul class="mb-2">
                      <li><strong>Proveedor:</strong> ${response.supplier}</li>
                      <li><strong>Archivo:</strong> ${response.filename}</li>
                      <li><strong>Productos cargados:</strong> ${response.total_products}</li>
                      <li><strong>Estado BD:</strong> ${response.db_status}</li>
                      <li><strong>Estado Proveedor:</strong> ${response.proveedor_status}</li>
                  </ul>
              </div>
              ${response.processing_summary ? createProcessingSummaryHTML(response.processing_summary) : ''}
              ${response.debug_available ? `<button class="btn btn-info btn-sm mt-2" onclick="showDebugDetails('${response.supplier}')">Ver Detalles de Procesamiento</button>` : ''}
          `;
          
          // Recargar lista de archivos
          loadFileList();
          
      } else {
          // Upload fallido
          messageDiv.className = 'alert alert-danger';
          messageDiv.innerHTML = `
              <h4>‚ùå ${response.message}</h4>
              <div class="mt-3">
                  <strong>Archivo:</strong> ${response.filename || 'Unknown'}<br>
                  <strong>Proveedor:</strong> ${response.supplier || 'Unknown'}
              </div>
              ${response.failure_analysis ? createFailureAnalysisHTML(response.failure_analysis) : ''}
              ${response.recommendations ? createRecommendationsHTML(response.recommendations) : ''}
              ${response.debug_info ? `<button class="btn btn-warning btn-sm mt-2" onclick="showFullDebugInfo(${JSON.stringify(response.debug_info)})">Ver Informaci√≥n Completa de Debug</button>` : ''}
          `;
      }
      
      messageDiv.style.display = 'block';
  }

  function createProcessingSummaryHTML(summary) {
      if (!summary || !summary.sheets_summary) return '';
      
      let html = `
          <div class="mt-3">
              <h5>üìä Resumen de Procesamiento:</h5>
              <div class="row">
                  <div class="col-md-6">
                      <strong>Calidad de Datos:</strong> ${summary.data_quality_score || 0}%
                  </div>
                  <div class="col-md-6">
                      <strong>Tasa de Extracci√≥n:</strong> ${summary.processing_efficiency?.extraction_rate?.toFixed(1) || 0}%
                  </div>
              </div>
              <div class="mt-2">
                  <h6>Hojas Procesadas:</h6>
                  <ul class="list-unstyled">
      `;
      
      summary.sheets_summary.forEach(sheet => {
          const successRate = sheet.success_rate?.toFixed(1) || 0;
          const statusIcon = successRate > 50 ? '‚úÖ' : successRate > 0 ? '‚ö†Ô∏è' : '‚ùå';
          
          html += `
              <li>${statusIcon} <strong>${sheet.sheet_name}:</strong> 
                  ${sheet.products_extracted} productos extra√≠dos 
                  (${successRate}% de ${sheet.rows_processed} filas)
                  ${sheet.columns_used ? `- Columnas: ${sheet.columns_used.product} / ${sheet.columns_used.price}` : ''}
              </li>
          `;
      });
      
      html += '</ul></div></div>';
      return html;
  }

  function createFailureAnalysisHTML(analysis) {
      if (!analysis) return '';
      
      let html = `
          <div class="mt-3 p-3 bg-light border rounded">
              <h5>üîç An√°lisis de Problemas:</h5>
      `;
      
      // Mostrar problemas primarios
      if (analysis.primary_issues && analysis.primary_issues.length > 0) {
          html += `<div class="mb-2"><strong>Problemas Principales:</strong> ${analysis.primary_issues.join(', ')}</div>`;
      }
      
      // Mostrar an√°lisis por hoja
      if (analysis.sheet_analysis && analysis.sheet_analysis.length > 0) {
          html += '<h6>An√°lisis por Hoja:</h6><ul>';
          analysis.sheet_analysis.forEach(sheet => {
              const status = sheet.status === 'failed' ? '‚ùå' : '‚ö†Ô∏è';
              html += `<li>${status} <strong>${sheet.sheet_name}:</strong> `;
              if (sheet.error) {
                  html += `Error: ${sheet.error}`;
              } else {
                  html += `${sheet.products_found} productos encontrados`;
              }
              html += '</li>';
          });
          html += '</ul>';
      }
      
      // Problemas de detecci√≥n de columnas
      if (analysis.column_detection_issues && analysis.column_detection_issues.length > 0) {
          html += '<h6>Problemas de Columnas:</h6><ul>';
          analysis.column_detection_issues.forEach(issue => {
              html += `<li><strong>${issue.sheet}:</strong> ${issue.detail}</li>`;
          });
          html += '</ul>';
      }
      
      html += '</div>';
      return html;
  }

  function createRecommendationsHTML(recommendations) {
      if (!recommendations || recommendations.length === 0) return '';
      
      let html = `
          <div class="mt-3 p-3 bg-warning bg-opacity-10 border border-warning rounded">
              <h5>üí° Recomendaciones:</h5>
              <ul>
      `;
      
      recommendations.forEach(rec => {
          const priorityIcon = rec.priority === 'high' ? 'üî¥' : rec.priority === 'medium' ? 'üü°' : 'üü¢';
          html += `
              <li class="mb-2">
                  ${priorityIcon} <strong>${rec.message}</strong>
                  ${rec.detailed_suggestion ? `<br><small class="text-muted">${rec.detailed_suggestion}</small>` : ''}
              </li>
          `;
      });
      
      html += '</ul></div>';
      return html;
  }

  function showDebugDetails(supplierName) {
      // Modal para mostrar detalles de debugging
      const modal = new bootstrap.Modal(document.getElementById('debugModal') || createDebugModal());
      
      // Cargar informaci√≥n de debug del proveedor
      fetch(`/debug/logs/${encodeURIComponent(supplierName)}`)
          .then(response => response.json())
          .then(data => {
              updateDebugModal(data, supplierName);
              modal.show();
          })
          .catch(error => {
              console.error('Error loading debug info:', error);
              alert('Error cargando informaci√≥n de debug');
          });
  }

  function createDebugModal() {
      const modalHTML = `
          <div class="modal fade" id="debugModal" tabindex="-1">
              <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h5 class="modal-title">Informaci√≥n de Debug</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body" id="debugModalBody">
                          <div class="text-center">
                              <div class="spinner-border" role="status">
                                  <span class="visually-hidden">Cargando...</span>
                              </div>
                          </div>
                      </div>
                      <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                      </div>
                  </div>
              </div>
          </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      return document.getElementById('debugModal');
  }

  function updateDebugModal(data, supplierName) {
      const body = document.getElementById('debugModalBody');
      
      if (data.success) {
          body.innerHTML = `
              <h6>üìä Resumen para: ${supplierName}</h6>
              <div class="row">
                  <div class="col-md-6">
                      <ul class="list-unstyled">
                          <li><strong>Total Productos:</strong> ${data.summary.total_products}</li>
                          <li><strong>Precio Promedio:</strong> $${data.summary.avg_price.toFixed(2)}</li>
                          <li><strong>Primera Carga:</strong> ${data.summary.first_load ? new Date(data.summary.first_load).toLocaleString() : 'N/A'}</li>
                          <li><strong>√öltima Actualizaci√≥n:</strong> ${data.summary.last_load ? new Date(data.summary.last_load).toLocaleString() : 'N/A'}</li>
                      </ul>
                  </div>
                  <div class="col-md-6">
                      <h6>üîç Muestra de Productos:</h6>
                      <div style="max-height: 200px; overflow-y: auto;">
                          <ul class="list-unstyled small">
                              ${data.sample_products.map(p => `
                                  <li>${p.product} - $${p.price.toFixed(2)}</li>
                              `).join('')}
                          </ul>
                      </div>
                  </div>
              </div>
              
              <div class="mt-3">
                  <h6>üõ†Ô∏è Herramientas de Debug:</h6>
                  <button class="btn btn-sm btn-outline-primary me-2" onclick="testPriceCleaning()">Test Limpieza Precios</button>
                  <button class="btn btn-sm btn-outline-info me-2" onclick="testColumnDetection()">Test Detecci√≥n Columnas</button>
                  <button class="btn btn-sm btn-outline-success" onclick="loadProcessingStats()">Estad√≠sticas Generales</button>
              </div>
              
              ${data.note ? `<div class="mt-3 p-2 bg-info bg-opacity-10 rounded"><small>${data.note}</small></div>` : ''}
          `;
      } else {
          body.innerHTML = `
              <div class="alert alert-danger">
                  <h6>Error cargando informaci√≥n de debug</h6>
                  <p>${data.error}</p>
              </div>
          `;
      }
  }

  function showFullDebugInfo(debugInfo) {
      console.log('üêõ INFORMACI√ìN COMPLETA DE DEBUG:', debugInfo);
      
      // Tambi√©n mostrar en un modal o alert para debug r√°pido
      const summary = debugInfo.structure_analysis ? 
          `Hojas encontradas: ${debugInfo.structure_analysis.total_sheets || 0}` : 
          'Informaci√≥n de estructura no disponible';
      
      alert(`DEBUG INFO:\n${summary}\n\nVer consola (F12) para informaci√≥n completa.`);
  }

  // Funciones de test para debugging
  function testPriceCleaning() {
      const testValues = prompt('Ingrese valores de precio para probar (separados por coma):');
      if (!testValues) return;
      
      fetch('/debug/test_price_cleaning', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
              test_values: testValues.split(',').map(v => v.trim())
          })
      })
      .then(response => response.json())
      .then(data => {
          console.log('üßπ RESULTADOS TEST LIMPIEZA:', data);
          
          let resultsHTML = '<h6>Resultados Test Limpieza Precios:</h6><table class="table table-sm"><thead><tr><th>Input</th><th>Output</th><th>Status</th></tr></thead><tbody>';
          
          data.test_results.forEach(result => {
              const rowClass = result.status === 'accepted' ? 'table-success' : 
                              result.status === 'rejected' ? 'table-warning' : 'table-danger';
              resultsHTML += `<tr class="${rowClass}"><td>${result.input}</td><td>${result.output || 'null'}</td><td>${result.status}</td></tr>`;
          });
          
          resultsHTML += '</tbody></table>';
          resultsHTML += `<p><strong>Resumen:</strong> ${data.summary.accepted} aceptados, ${data.summary.rejected} rechazados, ${data.summary.errors} errores</p>`;
          
          document.getElementById('debugModalBody').innerHTML = resultsHTML;
      })
      .catch(error => {
          console.error('Error en test:', error);
          alert('Error ejecutando test de limpieza');
      });
  }
  </script>
</body>
</html>